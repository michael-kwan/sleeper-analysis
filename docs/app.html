<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleeper Analytics - League Report</title>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: white;
        }

        .header p {
            font-size: 1.1em;
            color: rgba(255, 255, 255, 0.9);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin: 20px 0;
        }

        .loading h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card h3 {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(102, 126, 234, 0.2);
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .positive {
            color: #4ade80;
        }

        .negative {
            color: #f87171;
        }

        .error {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid #f87171;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .error h2 {
            color: #f87171;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Home</a>

        <div class="header">
            <h1 id="league-name">Loading...</h1>
            <p id="league-info">Fetching league information...</p>
        </div>

        <div class="loading" id="loading">
            <h2>üèà Analyzing Your League...</h2>
            <div class="spinner"></div>
            <p id="status">Fetching data from API...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Content will be generated by JavaScript -->
        </div>

        <div id="error" class="error" style="display: none;">
            <h2>‚ö†Ô∏è Error</h2>
            <p id="error-message"></p>
        </div>
    </div>

    <script>
        const API_BASE = 'https://sleeper-analysis-production.up.railway.app';

        // Get league ID from URL
        const params = new URLSearchParams(window.location.search);
        const leagueId = params.get('id');

        if (!leagueId) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = 'No league ID provided. Please go back and enter a league ID.';
            document.getElementById('loading').style.display = 'none';
        } else {
            generateReport(leagueId);
        }

        async function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        async function fetchAPI(endpoint) {
            const response = await fetch(`${API_BASE}${endpoint}`);
            if (!response.ok) {
                throw new Error(`API request failed: ${response.statusText}`);
            }
            return response.json();
        }

        async function generateReport(leagueId) {
            try {
                await updateStatus('üìä Fetching league information...');

                // Fetch league info from Sleeper API directly
                const league = await fetch(`https://api.sleeper.app/v1/league/${leagueId}`).then(r => r.json());

                // Update header
                document.getElementById('league-name').textContent = league.name;
                document.getElementById('league-info').textContent = `Season ${league.season} ‚Ä¢ ${league.total_rosters} Teams`;

                await updateStatus('üèÜ Fetching standings...');
                const standings = await fetchAPI(`/api/matchups/${leagueId}/standings?weeks=14`);

                await updateStatus('üéñÔ∏è Fetching awards...');
                const awards = await fetchAPI(`/api/awards/${leagueId}/season?weeks=14`);

                await updateStatus('üí∫ Fetching benchwarmer analysis...');
                const benchwarmers = await fetchAPI(`/api/benchwarmer/${leagueId}/league?weeks=14`);

                await updateStatus('üçÄ Fetching luck analysis...');
                const luck = await fetchAPI(`/api/luck/${leagueId}/league?weeks=14`);

                await updateStatus('üí∞ Fetching FAAB analysis...');
                const faab = await fetchAPI(`/api/faab/${leagueId}/report?weeks=14`);

                await updateStatus('üìù Generating report...');

                // Build HTML content
                let html = '<div class="stats-grid">';
                html += `<div class="stat-card"><h3>Teams</h3><div class="value">${league.total_rosters}</div></div>`;
                html += `<div class="stat-card"><h3>Weeks Played</h3><div class="value">14</div></div>`;
                html += `<div class="stat-card"><h3>Total FAAB Spent</h3><div class="value">$${faab.total_faab_spent}</div></div>`;
                html += `<div class="stat-card"><h3>High Score</h3><div class="value">${Math.max(...awards.weekly_awards.map(w => w.high_score)).toFixed(1)}</div></div>`;
                html += '</div>';

                // Standings
                html += '<div class="section"><h2>üèÜ League Standings</h2><table>';
                html += '<thead><tr><th>Rank</th><th>Team</th><th>Record</th><th>PF</th><th>PA</th><th>Diff</th></tr></thead><tbody>';
                standings.forEach((team, idx) => {
                    const diff = team.points_for - team.points_against;
                    const diffClass = diff > 0 ? 'positive' : 'negative';
                    html += `<tr>`;
                    html += `<td>${idx + 1}</td>`;
                    html += `<td>${team.team_name}</td>`;
                    html += `<td>${team.wins}-${team.losses}</td>`;
                    html += `<td>${team.points_for.toFixed(2)}</td>`;
                    html += `<td>${team.points_against.toFixed(2)}</td>`;
                    html += `<td class="${diffClass}">${diff > 0 ? '+' : ''}${diff.toFixed(2)}</td>`;
                    html += `</tr>`;
                });
                html += '</tbody></table></div>';

                // Weekly Awards
                html += '<div class="section"><h2>üéñÔ∏è Weekly Awards (High/Low Scorers)</h2><table>';
                html += '<thead><tr><th>Week</th><th>High Scorer</th><th>Score</th><th>Low Scorer</th><th>Score</th></tr></thead><tbody>';
                awards.weekly_awards.forEach(week => {
                    html += `<tr>`;
                    html += `<td>${week.week}</td>`;
                    html += `<td>${week.high_scorer}</td>`;
                    html += `<td class="positive">${week.high_score.toFixed(2)}</td>`;
                    html += `<td>${week.low_scorer}</td>`;
                    html += `<td class="negative">${week.low_score.toFixed(2)}</td>`;
                    html += `</tr>`;
                });
                html += '</tbody></table></div>';

                // Luck Analysis
                html += '<div class="section"><h2>üçÄ Luck Analysis</h2><table>';
                html += '<thead><tr><th>Team</th><th>Record</th><th>Expected W-L</th><th>Luck Score</th><th>SOS</th></tr></thead><tbody>';
                luck.team_reports.forEach(team => {
                    const luckClass = team.luck_score > 0 ? 'positive' : 'negative';
                    html += `<tr>`;
                    html += `<td>${team.team_name}</td>`;
                    html += `<td>${team.wins}-${team.losses}</td>`;
                    html += `<td>${team.expected_wins.toFixed(1)}-${team.expected_losses.toFixed(1)}</td>`;
                    html += `<td class="${luckClass}">${team.luck_score > 0 ? '+' : ''}${team.luck_score.toFixed(1)}</td>`;
                    html += `<td>${team.strength_of_schedule.avg_opponent_score.toFixed(1)}</td>`;
                    html += `</tr>`;
                });
                html += '</tbody></table></div>';

                // FAAB Rankings
                html += '<div class="section"><h2>üí∞ FAAB Efficiency Rankings</h2><table>';
                html += '<thead><tr><th>Rank</th><th>Team</th><th>Spent</th><th>Remaining</th><th>Total Points</th><th>Avg ROI</th></tr></thead><tbody>';
                faab.owner_rankings.forEach(owner => {
                    html += `<tr>`;
                    html += `<td>${owner.faab_efficiency_rank}</td>`;
                    html += `<td>${owner.owner_name}</td>`;
                    html += `<td>$${owner.total_faab_spent}</td>`;
                    html += `<td>$${owner.faab_remaining}</td>`;
                    html += `<td>${owner.total_points_from_faab.toFixed(1)}</td>`;
                    html += `<td>${owner.avg_roi.toFixed(2)}</td>`;
                    html += `</tr>`;
                });
                html += '</tbody></table></div>';

                // Best FAAB Pickups
                if (faab.best_value_pickups && faab.best_value_pickups.length > 0) {
                    html += '<div class="section"><h2>üíé Best Value FAAB Pickups</h2><table>';
                    html += '<thead><tr><th>Player</th><th>Owner</th><th>FAAB</th><th>Points</th><th>ROI</th></tr></thead><tbody>';
                    faab.best_value_pickups.slice(0, 10).forEach(pickup => {
                        html += `<tr>`;
                        html += `<td>${pickup.player_name} (${pickup.position})</td>`;
                        html += `<td>${pickup.owner_name}</td>`;
                        html += `<td>$${pickup.faab_spent}</td>`;
                        html += `<td>${pickup.points_during_ownership.toFixed(1)}</td>`;
                        html += `<td class="positive">${pickup.roi.toFixed(2)}</td>`;
                        html += `</tr>`;
                    });
                    html += '</tbody></table></div>';
                }

                // Benchwarmer Report
                html += '<div class="section"><h2>üí∫ Biggest Benchwarmers (Top 10)</h2><table>';
                html += '<thead><tr><th>Team</th><th>Total Bench Points</th><th>Worst Week</th><th>Points Left</th></tr></thead><tbody>';
                benchwarmers.team_reports.slice(0, 10).forEach(team => {
                    const worstWeek = team.weeks.reduce((max, w) => w.total_bench_points > max.total_bench_points ? w : max);
                    html += `<tr>`;
                    html += `<td>${team.team_name}</td>`;
                    html += `<td class="negative">${team.total_bench_points.toFixed(1)}</td>`;
                    html += `<td>Week ${worstWeek.week}</td>`;
                    html += `<td class="negative">${worstWeek.total_bench_points.toFixed(1)}</td>`;
                    html += `</tr>`;
                });
                html += '</tbody></table></div>';

                // Set content and hide loading
                document.getElementById('content').innerHTML = html;
                document.getElementById('content').style.display = 'block';
                document.getElementById('loading').style.display = 'none';

                // Render charts after content is loaded
                await updateStatus('üìä Rendering charts...');
                renderStandingsChart(standings);
                renderWeeklyScoresChart(awards);
                renderLuckScatterChart(luck);
                renderFAABChart(faab);
                renderBenchwarmerChart(benchwarmers);

            } catch (error) {
                console.error('Error generating report:', error);
                await showError(`Failed to generate report: ${error.message}`);
            }
        }

        // Chart rendering functions
        function renderStandingsChart(standings) {
            const teams = standings.map(s => s.team_name);
            const pointsFor = standings.map(s => s.points_for);
            const pointsAgainst = standings.map(s => s.points_against);

            const trace1 = {
                x: teams,
                y: pointsFor,
                name: 'Points For',
                type: 'bar',
                marker: { color: '#4ade80' }
            };

            const trace2 = {
                x: teams,
                y: pointsAgainst,
                name: 'Points Against',
                type: 'bar',
                marker: { color: '#f87171' }
            };

            const layout = {
                title: 'Points For vs Against',
                barmode: 'group',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                xaxis: { tickangle: -45 },
                margin: { b: 150 }
            };

            // Create chart div and render
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = '<div id="standings-chart" class="chart"></div>';
            document.querySelector('.section:nth-of-type(2)').after(chartDiv);

            Plotly.newPlot('standings-chart', [trace1, trace2], layout, {responsive: true});
        }

        function renderWeeklyScoresChart(awards) {
            const weeks = awards.weekly_awards.map(w => w.week);
            const highScores = awards.weekly_awards.map(w => w.high_score);
            const lowScores = awards.weekly_awards.map(w => w.low_score);

            const trace1 = {
                x: weeks,
                y: highScores,
                name: 'High Score',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#4ade80', width: 3 },
                marker: { size: 8 }
            };

            const trace2 = {
                x: weeks,
                y: lowScores,
                name: 'Low Score',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#f87171', width: 3 },
                marker: { size: 8 }
            };

            const layout = {
                title: 'Weekly High/Low Scores',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'Week' },
                yaxis: { title: 'Points' }
            };

            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = '<div id="weekly-chart" class="chart"></div>';
            document.querySelector('.section:nth-of-type(3)').after(chartDiv);

            Plotly.newPlot('weekly-chart', [trace1, trace2], layout, {responsive: true});
        }

        function renderLuckScatterChart(luck) {
            const teams = luck.team_reports.map(t => t.team_name);
            const luckScores = luck.team_reports.map(t => t.luck_score);
            const wins = luck.team_reports.map(t => t.wins);

            const trace = {
                x: luckScores,
                y: wins,
                text: teams,
                mode: 'markers+text',
                type: 'scatter',
                marker: {
                    size: 12,
                    color: luckScores,
                    colorscale: [[0, '#f87171'], [0.5, '#e0e0e0'], [1, '#4ade80']],
                    showscale: true,
                    colorbar: { title: 'Luck Score' }
                },
                textposition: 'top center'
            };

            const layout = {
                title: 'Luck vs Wins',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'Luck Score', zeroline: true },
                yaxis: { title: 'Wins' },
                shapes: [{
                    type: 'line',
                    x0: 0,
                    y0: 0,
                    x1: 0,
                    y1: 14,
                    line: { color: '#667eea', width: 2, dash: 'dash' }
                }]
            };

            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = '<div id="luck-chart" class="chart"></div>';
            document.querySelector('.section:nth-of-type(4)').after(chartDiv);

            Plotly.newPlot('luck-chart', [trace], layout, {responsive: true});
        }

        function renderFAABChart(faab) {
            const teams = faab.owner_rankings.map(o => o.owner_name);
            const roi = faab.owner_rankings.map(o => o.avg_roi);
            const spent = faab.owner_rankings.map(o => o.total_faab_spent);

            const trace = {
                x: teams,
                y: roi,
                type: 'bar',
                marker: {
                    color: roi,
                    colorscale: [[0, '#f87171'], [0.5, '#667eea'], [1, '#4ade80']],
                    showscale: false
                },
                text: spent.map(s => `$${s}`),
                textposition: 'outside'
            };

            const layout = {
                title: 'FAAB Efficiency (ROI)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                xaxis: { tickangle: -45 },
                yaxis: { title: 'Average ROI' },
                margin: { b: 150 }
            };

            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = '<div id="faab-chart" class="chart"></div>';
            document.querySelector('.section:nth-of-type(5)').after(chartDiv);

            Plotly.newPlot('faab-chart', [trace], layout, {responsive: true});
        }

        function renderBenchwarmerChart(benchwarmers) {
            const teams = benchwarmers.team_reports.map(t => t.team_name);
            const benchPoints = benchwarmers.team_reports.map(t => t.total_bench_points);

            const trace = {
                labels: teams,
                values: benchPoints,
                type: 'pie',
                marker: {
                    colors: ['#667eea', '#764ba2', '#f87171', '#4ade80', '#fbbf24', '#60a5fa', '#a78bfa', '#fb923c']
                },
                textinfo: 'label+percent',
                hoverinfo: 'label+value'
            };

            const layout = {
                title: 'Bench Points Distribution',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                showlegend: false
            };

            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = '<div id="benchwarmer-chart" class="chart"></div>';
            document.querySelector('.section:last-of-type').after(chartDiv);

            Plotly.newPlot('benchwarmer-chart', [trace], layout, {responsive: true});
        }
    </script>
</body>
</html>
